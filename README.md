# vpc-flow-log-mapper
 CLI application for mapping vpc flow logs. This project can be used as a python package acting as a global cli application named vpc-flow-log-mapper on your command line.

## How to run the project?
```bash
python vpc_flow_log_mapper.py
```

  ### Specify custom input file path, output directory path and custom vpc-flow-log fields
  ```bash
  python vpc_flow_log_mapper.py --input-file-path=static/inputs/sample2.log --output-dir-path=static/outputs/ --fields="dstport protocol packets bytes start end action log-status"
  ```

  ```bash
  python vpc_flow_log_mapper.py --input-file-path=static/inputs/sample1.log --output-dir-path=static/outputs/ --fields="version account-id interface-id srcaddr dstaddr srcport dstport protocol packets bytes start end action log-status"
  ```

## How to run the project as a python package?

1. Create a virtual env
```bash
python -m venv venv
```

2. Activate the virtual env

    Windows
    ```bash
    venv\Scripts\activate
    ```

    Linux/Mac OS
    ```bash
    source venv/bin/activate
    ```

3. Install the Project using pip
```bash
  pip install -e .
```

4. Run the cli application
```bash
vpc-flow-log-mapper
```

```bash
vpc-flow-log-mapper --input-file-path=static/inputs/sample2.log --output-dir-path=static/outputs/ --fields="dstport protocol packets bytes start end action log-status"
```

```bash
vpc-flow-log-mapper --input-file-path=static/inputs/sample1.log --output-dir-path=static/outputs/ --fields="version account-id interface-id srcaddr dstaddr srcport dstport protocol packets bytes start end action log-status"
```



## Project Structure

The project structure is as follows:
- **`venv/`**: Contains the virtual environment for Python dependencies. This directory is created by running `python -m venv venv`.

- **`src/`**: The source code for the project.
  - **`__init__.py`**: Marks the directory as a Python package.
  - **`main.py`**: The main entry point for the cli application which accepts the cli arguments.
  - **`utils/`**: A utils submodule directory contains various utility function needed in the mapping of VPC flow log files to the required output format. It contains following utilities
    - **`get_protocol_name`**: It converts the protocol no. in the vpc-flow-log to protocol name.
    - **`handle_hypen_data`**: It handles the hypen to underscore mapping as python data class don't support hypens.
    - **`map_vpc_flow_log_line`**: This function maps the logs from the log file to the python OOP class VPCFlowLog. This function also validates whether the no. of fields in the log file and the no. of fields in cli agrument matches.
    - **`read_vpc_flow_logs`**: This function reads the log file and extracts the data to be forwarded to the map_vpc_flow_log_line function.
    - **`get_int_fields`**: It gets all the integer fields in the VPCFlowLog Class which helps in data type conversion while reading the log files. This is automated and need not be hardcoded.
    - **`load_csv_to_dict_list`**: This file helps to load data from a CSV and store it in a list of dictionary. This is used to get the lookup data data.
    - **`create_tag_mapper`**: This function creates a reference map from the lookup table data which is used to map logs to the appropriate tags.
    - **`generate_output_data`**: This function generates the required output data.   
    - **`write_dict_to_csv`**: This function writes the data generated by the generate_output_data function to the mentioned files.
    - **`validate_vpc_flow_log_mapper_inputs`**: This function validates whether all the input fields are valid. It ensures that the path and files exists.  
  - **`models/`**: A models submodule directory has the VPCFLowLog data class which contains all the possible fields in a VPC flow log file as per the [AWS Flow Log Documentation](https://docs.aws.amazon.com/vpc/latest/userguide/flow-log-records.html).
  - **`services/`**: A services submodule directory contains the service layer code which interacts with various utility function to provide service to end user.
  - **`constant/`**: A constants submodule directory contains the protocol name-number mapping given [here](https://www.iana.org/assignments/protocol-numbers/protocol-numbers.xhtml).

- **`static/`**: The source code for the project.
  - **`inputs/`**: This directory contains various sample vpc flow log files to test. This directory contains the default sample vpc-flow-log-file. You can add your sample files here or use any other directory by mentioning in the command line argument.
  - **`outputs/`**: This directory is the default output directory. You can use some other directory by specifying in the command line argument
  - **`mapping/`**: The main entry point for the cli application which accepts the cli arguments.

- **`README.md`**: Provides documentation and information about the project.

- **`.gitignore`**: Specifies files and directories to be ignored by Git.

- **`setup.py`**: Specifies project packaging details.

- **`vpc_flow_log_mapper.py`**: The file responsible for starting the project.

## Command Line Arguments

| Command Line Argument | Required/Optional | Default Value | Details |
|----------|----------|----------|----------|
| --input-file-path | Optional | static/inputs/sample1.log | This argument asks for the input file path |
| --output-dir-path | Optional | static/outputs/ | This argument asks for the output directory path |
| --fields | Optional | version account-id interface-id srcaddr dstaddr srcport dstport protocol packets bytes start end action log-status | The argument asks for the fields in your vpc flow log file in the same order |

## Assumptions
1. The input would be a plain text (ascii) log file path which follows the convention and format of the vpc flow log files.
2. Even though there is a validation whether the no. of fields in a log line and the no. of fields mentioned as command line argument are equal or not, the order should be same in both places.
3. The VPCFlowLog class has some fields with datatype as integer. The fields should be strictly integer or else the program will return an error.
4. If the protocol no. is not in the protocol_mapping constants (IANA list based) then it will assigned the name "Unknown Protocol".
5. The input file path and the output directory path should be valid or else the program will return an error.
6. Please check the default values of each cli argument before execution.

## Test Cases
| Test Cases | Details |
|----------|----------|
| No. of fields in the --fields cli arg and the no. of fields in the --input_file_path log's line should match | The test cases validates whether the no. of fields in the input file and the input format as same or not. The failure case for this can be tested using sample4-failure.log |
| The data type of all the fields in the log file should match the VPCFlowLog format | The test cases validates whether the values of the integer fields is digit or not. The failure scenario for this test cases can be tested using sample3-failure.log |
| Protocol number without any name mapping is set to "Unknown Protocol" | The test cases validates whether a invalid protocol no. is set to the name "Unknown protocol". This scenario can be tested using the sample5.log |
| The input file path and the output directory path is valid | The test cases validates whether the input file path and output directory path is valid. It returns an error if atleast one of the condition is not met  |
